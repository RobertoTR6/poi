ESPECIFICACIONES TÉCNICASAplicación Web — Herramienta de Monitoreo RIS IniciadorasVersión 2.0  —  Arquitectura Cloudflare + SupabaseFebrero 20261. Descripción General del ProyectoLa presente especificación describe el diseño técnico completo para el desarrollo de una aplicación web que digitaliza la Herramienta de Monitoreo del Funcionamiento de las Redes Integradas de Salud (RIS) Iniciadoras del MINSA.El instrumento opera actualmente en formato Excel. La aplicación reemplaza ese flujo con un sistema multiusuario, con registro de evidencias, control de acceso por roles, guardado automático eficiente y dashboard comparativo en el tiempo.Contexto institucionalEl instrumento monitorea 47 verificadores distribuidos en 12 componentes (Aspectos Generales + 11 Líneas de Intervención). Cada verificador se califica 0 (No cumple), 1 (En proceso) o 2 (Cumple). La aplicación es de uso interno, con periodicidad trimestral, y será utilizada por equipos de MINSA y DIRESA/GERESA/DIRIS a nivel nacional.2. Decisión de Arquitectura: Por qué Cloudflare + Supabase2.1 El problema con Supabase soloEl guardado automático es una característica crítica del formulario: cada vez que un monitor cambia un puntaje o escribe una observación, se dispara una escritura a la base de datos. En una sesión típica de evaluación de los 47 verificadores, esto genera entre 50 y 150 requests directos a Supabase.Con múltiples monitores trabajando simultáneamente durante un trimestre, el volumen de requests escala rápidamente. Supabase en su plan gratuito no tiene un límite explícito de requests, pero la conexión directa desde el navegador abre una conexión por usuario, lo que en PostgreSQL es costoso. Supabase recomienda no superar 60 conexiones simultáneas en el plan gratuito.Adicionalmente, Supabase Storage gratuito ofrece solo 1 GB. Con 20 RIS activas, 4 trimestres y archivos de evidencia adjuntos, ese límite se agota en el primer trimestre.2.2 Por qué Cloudflare resuelve ambos problemasCloudflare Workers como capa intermediaEn lugar de que el frontend escriba directamente a Supabase en cada cambio, un Cloudflare Worker actúa como intermediario. El Worker implementa batching: acumula los cambios del usuario durante 3-5 segundos y los escribe a Supabase en una sola transacción. Esto reduce las escrituras a Supabase en un 85-90%, haciendo el plan gratuito sostenible por mucho más tiempo.Cloudflare Workers gratuito: 100,000 requests/día. Workers de pago: 10 millones de requests/mes por 5 USD. Para una app interna de monitoreo gubernamental, 10 millones/mes es prácticamente ilimitado.Cloudflare R2 para evidenciasR2 es el servicio de almacenamiento de objetos de Cloudflare. Ventaja clave sobre Supabase Storage: sin costo de egress (salida de datos). El plan gratuito ofrece 10 GB de almacenamiento y 1 millón de operaciones de escritura por mes.Estimación de almacenamiento20 RIS × 4 trimestres × 47 verificadores × 2 archivos promedio × 500 KB = 3.76 GB al año. Con R2 gratuito (10 GB) tienes cobertura para aproximadamente 2.5 años antes de incurrir en costos. Con Supabase Storage gratuito (1 GB) el límite se alcanzaría en el primer trimestre.Cloudflare Pages para el frontendCDN global con puntos de presencia en múltiples ciudades de Latinoamérica. Deploys automáticos desde GitHub. HTTPS automático. Dominio gratuito en pages.dev. Para una aplicación accedida desde regiones remotas del país, la latencia reducida por el CDN mejora la experiencia notablemente.2.3 Lo que Supabase sigue haciendo mejorLa base de datos con Row Level Security (RLS) es el núcleo del control de acceso del sistema. Cloudflare D1 (su base de datos) usa SQLite distribuido sin soporte nativo de RLS comparable a PostgreSQL. Implementar el control de acceso por roles sin RLS implicaría hacerlo todo en lógica de aplicación, aumentando significativamente la complejidad y el riesgo de errores de seguridad.Supabase Auth también resuelve la autenticación en pocas líneas de código, con manejo de sesiones, tokens JWT y middleware de RLS integrado. Reemplazarlo con Cloudflare Access añadiría complejidad innecesaria.3. Stack Tecnológico3.1 Diagrama de serviciosCapaServicioResponsabilidadFrontendCloudflare PagesHosting del app React. CDN global. Deploy desde GitHub.Lógica intermediaCloudflare WorkersBatching del guardado automático. URLs firmadas para R2. Lógica de negocio que no va al cliente.Almacenamiento archivosCloudflare R2Evidencias adjuntas por verificador. 10 GB gratis, sin costo de egress.Base de datosSupabase PostgreSQLDatos de evaluaciones, calificaciones, usuarios, RIS. RLS para control de acceso.AutenticaciónSupabase AuthLogin, sesiones, tokens JWT. Integrado con RLS.3.2 Frontend (Cloudflare Pages)TecnologíaVersiónJustificaciónVite + ReactReact 18+Sin necesidad de SSR. Build estático compatible con Pages.Tailwind CSSv3+Componentes repetitivos (47 verificadores). Desarrollo rápido.React Routerv6+Navegación entre vistas.RechartsÚltima estableGráficos del dashboard. Más sencillo que D3 para este caso.@supabase/supabase-jsv2+Cliente para autenticación y lectura de datos.3.3 Cloudflare WorkersLos Workers son funciones serverless que corren en el edge de Cloudflare, cerca del usuario. Se escriben en JavaScript/TypeScript. Se despliegan junto con el proyecto en el mismo repositorio usando Wrangler CLI.Para este proyecto se necesitan tres Workers principales:WorkerFunciónsave-batchRecibe los cambios acumulados del formulario y los escribe a Supabase en una sola transacción. Implementa debounce de 4 segundos del lado del servidor.upload-evidenceGenera URLs firmadas para subir archivos directamente a R2 desde el navegador sin pasar por Supabase. Valida que el usuario tenga permiso sobre la evaluación.get-evidence-urlGenera URLs firmadas temporales para descargar archivos de R2. Las URLs expiran en 1 hora para proteger el acceso.Flujo del guardado automático con batching1. El monitor cambia un puntaje o escribe una observación. 2. El frontend acumula el cambio en un buffer local (estado React). 3. Tras 4 segundos sin nuevos cambios, el frontend envía todos los cambios acumulados al Worker save-batch en un solo request. 4. El Worker valida el token JWT del usuario y escribe los cambios a Supabase en una transacción. 5. El resultado se devuelve al frontend. Esto reduce las escrituras a Supabase de ~150 a ~10 por sesión de evaluación completa.4. Modelo de Datos (Supabase / PostgreSQL)El modelo contempla 6 tablas principales en Supabase. Los archivos de evidencia no se almacenan en Supabase sino en Cloudflare R2; la tabla evidencias guarda únicamente la referencia (path en R2).4.1 Tabla: risCatálogo cerrado de Redes Integradas de Salud. Lo gestiona únicamente el administrador.CampoTipoRequeridoDescripcióniduuid (PK)SíIdentificador único generado automáticamente.nombretextSíNombre completo de la RIS.diresatextSíDIRESA / GERESA / DIRIS responsable.regiontextSíRegión geográfica.activobooleanSíPermite desactivar sin eliminar.4.2 Tabla: usuariosExtiende auth.users de Supabase. Se crea automáticamente al registrar un usuario desde el panel de administración.CampoTipoRequeridoDescripcióniduuid (FK auth)SíReferencia a auth.users.id.nombre_completotextSíNombre para mostrar en la aplicación.rolenumSíadmin | monitor | supervisor.activobooleanSíPermite suspender acceso sin eliminar.4.3 Tabla: asignacionesRelaciona monitores con las RIS que tienen permitido evaluar, por período trimestral.CampoTipoRequeridoDescripcióniduuid (PK)SíIdentificador único.usuario_iduuid (FK)SíReferencia a usuarios.id.ris_iduuid (FK)SíReferencia a ris.id.periodotextSíFormato: '2025-T2'. Permite reasignar cada trimestre.4.4 Tabla: evaluacionesUna evaluación por RIS por período. Es la unidad central del sistema.CampoTipoRequeridoDescripcióniduuid (PK)SíIdentificador único.ris_iduuid (FK)SíRIS evaluada.periodotextSíEj.: '2025-T2'.equipo_monitortextNoTexto libre con integrantes del equipo.estadoenumSíborrador | cerrada | reabierta.creado_poruuid (FK)SíUsuario que inició la evaluación.cerrado_poruuid (FK)NoUsuario que cerró la evaluación.cerrado_entimestamptzNoFecha y hora del cierre.reabierto_poruuid (FK)NoAdministrador que reabrió.reabierto_entimestamptzNoFecha y hora de reapertura.Lógica de estadosborrador → cerrada: acción del monitor. cerrada → reabierta: solo el administrador. reabierta → cerrada: acción del monitor. No existe transición directa de reabierta a borrador.4.5 Tabla: calificacionesUn registro por verificador por evaluación. Se inicializa con puntaje 0 al crear la evaluación.CampoTipoRequeridoDescripcióniduuid (PK)SíIdentificador único.evaluacion_iduuid (FK)SíReferencia a evaluaciones.id.numero_verificadorintegerSí1 al 47. Identifica el verificador.puntajeintegerSí0, 1 o 2. Default: 0.observaciontextNoCampo libre de observaciones por verificador.actualizado_poruuid (FK)NoÚltimo usuario que modificó el registro.actualizado_entimestamptzNoTimestamp de última modificación.4.6 Tabla: evidenciasMetadatos de los archivos adjuntos. Los archivos físicos se almacenan en Cloudflare R2. Esta tabla solo guarda la referencia.CampoTipoRequeridoDescripcióniduuid (PK)SíIdentificador único.calificacion_iduuid (FK)SíReferencia a calificaciones.id.nombre_archivotextSíNombre original del archivo subido.r2_pathtextSíPath en R2: evaluaciones/{id}/verificador_{n}/{archivo}.tipo_archivotextNoMIME type: application/pdf, image/jpeg, etc.tamano_bytesbigintNoTamaño del archivo para mostrar en la UI.subido_poruuid (FK)SíUsuario que adjuntó el archivo.subido_entimestamptzSíTimestamp de carga.5. Control de Acceso por Roles5.1 Row Level Security en SupabaseEl control de acceso se implementa mediante RLS en PostgreSQL. Las políticas garantizan que ningún usuario pueda leer ni escribir datos fuera de su ámbito, incluso si accede directamente a la API de Supabase sin pasar por el frontend.AcciónAdministradorMonitorSupervisorCrear / editar usuariosSINONOAsignar RIS a monitoresSINONOReabrir evaluación cerradaSINONOEditar calificaciones (RIS asignadas)SISINOCerrar evaluación propiaSISINOVer evaluaciones de TODAS las RISSISI (lectura)SIAdjuntar evidenciasSISI (RIS propias)NOVer dashboard globalSISISI5.2 Validación en Cloudflare WorkersLos Workers validan el JWT de Supabase en cada request antes de procesar cualquier operación. Esto garantiza una doble capa de seguridad: RLS en la base de datos y validación de identidad en la capa intermedia. El Worker verifica que el usuario tenga asignada la RIS antes de procesar el guardado o la subida de archivos.6. Vistas de la Aplicación6.1 /loginAutenticación por email y contraseña vía Supabase Auth. Sin opción de registro propio: los usuarios los crea el administrador. Redirección automática al dashboard tras login exitoso.6.2 /admin — Panel de AdministraciónAcceso exclusivo para el rol administrador. Cuatro secciones en navegación lateral:Usuarios: tabla con todos los usuarios, creación, edición de rol y activar/desactivar.Catálogo de RIS: tabla con todas las RIS. Activar/desactivar.Asignaciones: grilla período × RIS con los monitores asignados a cada una.Reaperturas: listado de evaluaciones cerradas con botón Reabrir por cada una.6.3 /evaluacion/:ris_id/:periodo — FormularioEncabezadoNombre de la RIS y DIRESA (del catálogo, no editable).Período trimestral (de la URL, no editable).Equipo monitor: campo de texto libre editable.Estado de la evaluación: badge Borrador / Cerrada / Reabierta.Barra de progreso: % de verificadores con puntaje mayor a 0.Indicador de guardado: Guardando... / Guardado / Error al guardar.Navegación por componentesPanel lateral con los 12 componentes. Cada uno muestra progreso visual (verificadores completados / total). Al hacer clic navega al bloque del componente correspondiente.VerificadoresPor cada verificador se muestra: número y descripción, fuentes auditables (texto informativo), especificaciones de puntaje (colapsable), selector de calificación con código de color (0 rojo / 1 amarillo / 2 verde), campo de observaciones y lista de evidencias adjuntas con opción de agregar o eliminar.Guardado automático con batchingLos cambios se acumulan en un buffer local durante 4 segundos. Transcurrido ese tiempo, se envían al Worker save-batch en un solo request. El buffer se vacía inmediatamente si el usuario navega a otro componente o cierra el formulario. El indicador de estado es visible en todo momento.Cierre de evaluaciónBotón visible solo en estado borrador o reabierta. Al confirmar en el modal de resumen, cambia el estado a cerrada, registra cerrado_por y cerrado_en, y bloquea la edición.6.4 /dashboard — Dashboard GlobalControles superioresSelector de período trimestral.Selector de RIS individual para ver el detalle.Tabla consolidadaUna fila por componente con: nombre, puntaje obtenido, puntaje máximo, % de cumplimiento y badge de nivel de avance.NivelUmbralColorÓPTIMO75% o másVerdeEN PROCESO40% a 74%AmarilloBAJOMenos de 40%Rojo/NaranjaGráficosBarras horizontales: % de cumplimiento por componente para el período seleccionado.Líneas: evolución del puntaje total por trimestre.6.5 /dashboard/:ris_id — Detalle por RISMisma estructura que el dashboard global pero filtrado a una RIS específica. Accesible por todos los roles incluyendo monitores que no tienen esa RIS asignada (solo lectura).7. Estructura del Repositorio/
├── src/                          # Frontend React
│   ├── components/
│   │   ├── ui/                   # Button, Badge, Modal, Spinner
│   │   ├── verificador/          # VerificadorCard, SelectorPuntaje, EvidenciasList
│   │   ├── dashboard/            # GraficoBarras, TablaConsolidado, GraficoEvolucion
│   │   └── layout/               # Sidebar, Topbar, ProtectedRoute
│   ├── pages/
│   │   ├── Login.jsx
│   │   ├── Admin.jsx
│   │   ├── Evaluacion.jsx
│   │   ├── Dashboard.jsx
│   │   └── DashboardRIS.jsx
│   ├── hooks/
│   │   ├── useEvaluacion.js      # Lógica de carga, buffer y envío al Worker
│   │   ├── useAuth.js            # Sesión y rol del usuario
│   │   └── useDashboard.js       # Datos agregados para el dashboard
│   ├── lib/
│   │   ├── supabase.js           # Cliente Supabase (solo auth y lectura)
│   │   ├── workers.js            # Cliente para llamar a los CF Workers
│   │   └── verificadores.js      # Array estático: los 47 verificadores
│   └── utils/
│       └── calculos.js           # puntajeComponente, porcentaje, nivelAvance
│
├── workers/                      # Cloudflare Workers
│   ├── save-batch/               # Batching del guardado automático
│   ├── upload-evidence/          # URLs firmadas para subir a R2
│   └── get-evidence-url/         # URLs firmadas para descargar de R2
│
├── supabase/
│   ├── migrations/               # SQL de creación de tablas y políticas RLS
│   └── seed.sql                  # Datos iniciales: catálogo de RIS
│
├── wrangler.toml                 # Configuración de Cloudflare Workers y R2
└── .env                          # Variables de entorno (no commitear)8. Estimación de Costos y Escalabilidad8.1 Plan gratuito — capacidad estimadaServicioLímite gratuitoUso estimado/añoMargenSupabase DB500 MB< 50 MBMuy holgadoSupabase Auth50,000 usuarios< 100 usuariosMuy holgadoCF Workers100,000 req/día~500 req/díaMuy holgadoCF R210 GB storage~3.76 GB/año2.5 añosCF PagesIlimitadoN/AIlimitado8.2 Costo si se requiere escalarServicioCostoCuándo necesitarloSupabase ProUSD 25/mesSi se supera 500 MB en DB o se necesita uptime garantizado sin pausas.CF Workers PaidUSD 5/mesSi se supera 100,000 req/día (equivale a ~400 monitores activos simultáneos).CF R2 (exceso)USD 0.015/GBSolo al superar 10 GB. A 3.76 GB/año el costo comienza recién en el tercer año.Proyección de costo para los primeros 2 añosCon el plan gratuito de ambos servicios, el costo total de infraestructura es USD 0. Si el sistema crece a 50+ RIS activas o se requiere SLA formal, el costo máximo estimado es USD 30/mes (Supabase Pro + CF Workers Paid), lo que equivale a USD 360 al año.9. Variables de EntornoEl proyecto requiere las siguientes variables. Las del frontend usan el prefijo VITE_. Las de los Workers se configuran en wrangler.toml o como secrets de Cloudflare.# Frontend (.env)
VITE_SUPABASE_URL=https://xxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJ...
VITE_WORKER_BASE_URL=https://workers.tu-dominio.workers.dev

# Workers (wrangler.toml / secrets)
SUPABASE_URL=https://xxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJ...   # Solo en Workers, nunca en el frontend
R2_BUCKET_NAME=evidencias-risImportanteEl SUPABASE_SERVICE_ROLE_KEY nunca debe estar en el frontend ni en el repositorio. Solo vive como secret en Cloudflare Workers. Este key otorga acceso completo sin RLS y debe manejarse con máximo cuidado.10. Fases de DesarrolloFaseAlcanceEntregables1Infraestructura baseRepositorio GitHub. Setup Vite + Tailwind. Tablas Supabase con RLS. Supabase Auth funcionando. Cloudflare Pages conectado al repo. Wrangler CLI configurado.2Workers y R2Bucket R2 creado. Worker save-batch con batching de 4 segundos. Worker upload-evidence con URLs firmadas. Worker get-evidence-url. Tests de integración.3Formulario de evaluaciónVista /evaluacion completa con los 47 verificadores, guardado automático via Worker, adjunto de evidencias a R2, cierre de evaluación.4DashboardVista /dashboard con tabla consolidada, gráfico de barras, selector de período y gráfico de evolución. Vista de detalle /dashboard/:ris_id.5Panel de administraciónVista /admin con gestión de usuarios, asignaciones, catálogo de RIS y reaperturas.6RefinamientoPruebas con usuarios reales. Ajustes de UX. Verificación de RLS con distintos roles. Optimización de queries. Dominio personalizado en Pages.Versión 2.0 — Documento preparado para revisión y aprobación antes del inicio del desarrollo.